<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>PrimordiumEvolv</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
  :root{
    --bg:#0b0f14;
    --bg-grad-1:#0b0f14;
    --bg-grad-2:#0a0f1a;
    --panel:rgba(17,25,40,0.55);
    --panel-2:rgba(11,17,26,0.55);
    --border:rgba(255,255,255,0.08);
    --text:#e5e7eb;
    --muted:#a5b4fc;
    --primary:#8b5cf6;
    --primary-700:#7c3aed;
    --accent:#22d3ee;
    --success:#22c55e;
    --danger:#ef4444;
    --warning:#f59e0b;
    --surface:rgba(15,23,42,0.45);
    --code:rgba(13,17,23,0.55);
    --blur:12px;
    --shadow:0 8px 30px rgba(0,0,0,0.45);
  }
  html,body{
    background: radial-gradient(1200px 600px at 10% -10%, rgba(124,58,237,0.12), transparent 60%),
                radial-gradient(1000px 500px at 110% 10%, rgba(34,211,238,0.10), transparent 50%),
                linear-gradient(180deg, var(--bg-grad-1), var(--bg-grad-2));
    color:var(--text);
    font-family:ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
    margin:0;
    padding:0;
    min-height:100vh;
  }
  body{max-width:1000px;margin:0 auto;padding:20px}
  
  /* Evolution UI Styles */
  .main-container{background:var(--panel);border:1px solid var(--border);border-radius:20px;padding:32px;backdrop-filter:blur(var(--blur));-webkit-backdrop-filter:blur(var(--blur));box-shadow:var(--shadow);margin-bottom:24px}
  .section{background:var(--panel-2);border:1px solid var(--border);border-radius:16px;padding:24px;margin:16px 0;backdrop-filter:blur(var(--blur));-webkit-backdrop-filter:blur(var(--blur))}
  .collapsed-section{background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:16px;margin:12px 0;backdrop-filter:blur(calc(var(--blur) - 4px));-webkit-backdrop-filter:blur(calc(var(--blur) - 4px))}
  
  /* Form Controls */
  input, select, textarea{
    background-color: var(--surface) !important;
    color: var(--text) !important;
    border: 1px solid var(--border) !important;
    border-radius: 10px;
    padding: 12px;
    backdrop-filter: blur(calc(var(--blur) - 4px));
    -webkit-backdrop-filter: blur(calc(var(--blur) - 4px));
    font-size: 1em;
  }
  input::placeholder, textarea::placeholder{ color: #9ca3af; opacity: 1; }
  input:focus, select:focus, textarea:focus{ outline: none; border-color: var(--accent) !important; box-shadow: 0 0 0 2px rgba(34,211,238,0.25); }
  
  /* Buttons */
  .primary-btn{background:linear-gradient(135deg,var(--primary),var(--primary-700));color:white;border:none;padding:16px 32px;font-size:1.2em;font-weight:600;border-radius:12px;cursor:pointer;box-shadow:var(--shadow);transition:all 0.3s}
  .primary-btn:hover{transform:translateY(-1px);box-shadow:0 12px 40px rgba(0,0,0,0.6)}
  .secondary-btn{background:var(--surface);color:var(--text);border:1px solid var(--border);padding:10px 18px;border-radius:8px;cursor:pointer;font-size:0.9em}
  .secondary-btn:hover{background:var(--panel);border-color:var(--accent)}
  
  /* Progress & Status */
  .progress-container{background:var(--surface);height:12px;border-radius:6px;overflow:hidden;margin:16px 0}
  .progress-bar{background:linear-gradient(90deg,var(--primary),var(--accent));height:100%;width:0%;transition:width 0.5s ease;border-radius:6px}
  .status-badge{display:inline-block;padding:4px 12px;border-radius:20px;font-size:0.85em;font-weight:500;margin:0 4px;background:var(--panel-2);border:1px solid var(--border);color:var(--text)}
  .status-ok{border-left:4px solid var(--success)}
  .status-error{border-left:4px solid var(--danger)}
  
  /* Evolution Steps */
  .evolution-step{padding:12px 16px;margin:8px 0;background:var(--surface);border-radius:10px;display:flex;justify-content:space-between;align-items:center;font-size:0.95em}
  .evolution-step.running{background:linear-gradient(90deg, var(--surface), rgba(139,92,246,0.15));animation:pulse 2s infinite}
  .evolution-step.completed{background:linear-gradient(90deg, var(--surface), rgba(34,197,94,0.15))}
  @keyframes pulse{0%{opacity:1}50%{opacity:0.7}100%{opacity:1}}
  
  /* Collapsible sections */
  details summary{cursor:pointer;user-select:none;color:var(--muted);padding:8px 0}
  details[open] summary{color:var(--primary)}
  details > div{margin-top:12px}
  
  /* Results */
  .result-card{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:20px;margin:12px 0}
  .result-score{font-size:2em;font-weight:bold;color:var(--accent);text-align:center;margin:8px 0}
  .result-improvement{text-align:center;color:var(--success);font-size:1.1em;margin:8px 0}
  
  /* Rating Panel */
  .rating-panel{animation:slideIn 0.3s ease}
  .rating-btn:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(0,0,0,0.3)}
  @keyframes slideIn{0%{opacity:0;transform:translateY(-10px)}100%{opacity:1;transform:translateY(0)}}
  
  /* Utility */
  .hidden{display:none}
  .text-center{text-align:center}
  .text-muted{color:var(--muted)}
  .mt-1{margin-top:8px}
  .mt-2{margin-top:16px}
  .mb-2{margin-bottom:16px}
  .flex{display:flex}
  .flex-between{justify-content:space-between}
  .flex-center{justify-content:center}
  .flex-align{align-items:center}
  .gap-2{gap:16px}
  .w-full{width:100%}
  </style>
</head>
<body>
  <div class="text-center mb-2">
    <h1 style="margin:0;font-size:2.5em;background:linear-gradient(135deg,var(--primary),var(--accent));-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;">PrimordiumEvolv</h1>
    <p style="color:var(--muted);font-size:1.2em;margin:8px 0 0 0;">Self-Evolving AI System â€” Local generation; Groq evaluates only</p>
  </div>

  <!-- System Health -->
  <div class="flex flex-center flex-align gap-2 mb-2">
    <span id="ollamaHealth" class="status-badge">Ollama: checking...</span>
    <span id="groqHealth" class="status-badge">Groq: checking...</span>
    <button onclick="checkHealth()" class="secondary-btn" style="padding:4px 8px;font-size:0.8em">ğŸ”„</button>
  </div>

  <!-- Main Evolution Interface -->
  <div class="main-container">
    <div class="text-center mb-2">
      <h2 style="margin:0 0 8px 0;font-size:1.4em;color:var(--text)">ğŸ¯ What should the AI get better at?</h2>
      <p class="text-muted" style="margin:0;font-size:0.95em">Describe a task and watch the AI evolve to become better at it</p>
    </div>
    
    <textarea id="evolutionTask" 
              placeholder="e.g., 'Write Python functions with good error handling', 'Analyze business data and find insights', 'Create engaging marketing copy'..." 
              style="width:100%;height:120px;margin:16px 0;font-size:1.1em;resize:vertical"></textarea>
    
    <div class="flex flex-between flex-align gap-2 mb-2">
      <div class="flex flex-align gap-2">
        <label class="flex flex-align gap-2">
          <span class="text-muted">Task Type:</span>
          <select id="taskType" style="padding:8px">
            <option value="code">Code & Programming</option>
            <option value="analysis">Data Analysis</option>
            <option value="writing">Creative Writing</option>
            <option value="business">Business Strategy</option>
            <option value="research">Research & Facts</option>
            <option value="other">General Task</option>
          </select>
        </label>
        
        <label class="flex flex-align gap-2">
          <span class="text-muted">Iterations:</span>
          <input id="evolutionIterations" type="number" value="12" min="2" max="24" style="width:80px;padding:8px">
        </label>
      </div>
      
      <button id="startEvolution" onclick="startEvolution()" class="primary-btn">
        ğŸš€ Start Evolution
      </button>
    </div>
  </div>
  
  <!-- Evolution Progress -->
  <div id="evolutionProgress" class="section hidden">
    <h3 style="margin:0 0 16px 0">ğŸ§¬ Evolution in Progress</h3>
    <div class="progress-container">
      <div id="progressBar" class="progress-bar"></div>
    </div>
    <div id="evolutionSteps"></div>
    <div id="currentOutput" class="evolution-step" style="margin-top:16px;font-family:monospace;font-size:0.9em;background:var(--code);min-height:100px;max-height:400px;padding:16px;white-space:pre-wrap;overflow-y:auto;border-radius:8px;border:1px solid var(--border)"></div>
    
    <!-- Human Rating Panel -->
    <div id="ratingPanel" class="rating-panel hidden" style="margin-top:16px;padding:16px;background:var(--panel);border-radius:10px;border:1px solid var(--accent)">
      <h4 style="margin:0 0 12px 0;color:var(--accent)">ğŸ§‘â€âš–ï¸ Rate This Response</h4>
      <div style="display:flex;gap:12px;align-items:center;margin-bottom:8px">
        <button id="rateGood" class="rating-btn" style="background:var(--success);color:white;border:none;padding:8px 16px;border-radius:6px;cursor:pointer">ğŸ‘ Good</button>
        <button id="ratePoor" class="rating-btn" style="background:var(--danger);color:white;border:none;padding:8px 16px;border-radius:6px;cursor:pointer">ğŸ‘ Poor</button>
        <span class="text-muted">or</span>
        <input id="detailedRating" type="range" min="1" max="10" value="5" style="flex:1">
        <span id="ratingValue" class="text-muted">5/10</span>
      </div>
      <div style="display:flex;gap:8px;align-items:center">
        <input id="ratingFeedback" type="text" placeholder="Optional feedback..." style="flex:1;padding:8px;background:var(--surface);border:1px solid var(--border);border-radius:6px;color:var(--text)">
        <button id="submitRating" class="secondary-btn" style="padding:8px 16px">Submit Rating</button>
      </div>
      <div id="ratingStatus" class="text-muted" style="margin-top:8px;font-size:0.85em"></div>
    </div>
  </div>
  
  <!-- Results -->
  <div id="evolutionResults" class="section hidden">
    <h3 style="margin:0 0 16px 0">ğŸ† Evolution Complete!</h3>
    <div id="resultsContent"></div>
  </div>

  <!-- Quick Test -->
  <div class="collapsed-section">
    <details>
      <summary>ğŸ’¬ Quick Test Current AI</summary>
      <div>
        <textarea id="testPrompt" placeholder="Test the current AI with a quick prompt..." style="width:100%;height:80px;margin-bottom:8px"></textarea>
        <div class="flex gap-2">
          <button onclick="quickTest()" class="secondary-btn">Test</button>
          <button onclick="streamTest()" class="secondary-btn">Stream Test</button>
        </div>
        <div id="testOutput" style="margin-top:12px;padding:12px;background:var(--code);border-radius:8px;font-family:monospace;font-size:0.9em;white-space:pre-wrap;min-height:60px;display:none"></div>
      </div>
    </details>
  </div>

  <!-- Advanced Settings -->
  <div class="collapsed-section">
    <details>
      <summary>âš™ï¸ Advanced Evolution Settings</summary>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px">
        <label id="epsilonGroup" style="display:flex;flex-direction:column;gap:4px;opacity:0.5">
          <span class="text-muted">Learning Rate (Îµ)</span>
          <input id="advEpsilon" type="number" value="0.3" step="0.05" min="0" max="1" style="width:100%" disabled>
        </label>
        <label style="display:flex;flex-direction:column;gap:4px">
          <span class="text-muted">Memory Context</span>
          <input id="advMemoryK" type="number" value="3" min="0" max="10" style="width:100%">
        </label>
        <label style="display:flex;flex-direction:column;gap:4px">
          <span class="text-muted">Strategy</span>
          <select id="advStrategy" style="width:100%" onchange="toggleEpsilonVisibility()">
            <option value="ucb">UCB1 (Recommended)</option>
            <option value="epsilon_greedy">Epsilon Greedy</option>
          </select>
        </label>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;margin-top:16px">
        <label style="display:flex;flex-direction:column;gap:4px">
          <span class="text-muted">RAG Context</span>
          <input id="advRagK" type="number" value="3" min="0" max="10" style="width:100%">
        </label>
        <label style="display:flex;flex-direction:column;gap:4px">
          <span class="text-muted">Web Research</span>
          <input type="checkbox" id="advUseWeb" checked style="transform:scale(1.5);margin:8px">
        </label>
        <div></div>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-top:16px">
        <label style="display:flex;flex-direction:column;gap:4px">
          <span class="text-muted">Ratings Mode</span>
          <select id="ratingsMode" style="width:100%">
            <option value="prompted">Prompted (default)</option>
            <option value="off">Off</option>
          </select>
        </label>
        <label style="display:flex;flex-direction:column;gap:4px">
          <span class="text-muted">Reading Delay (ms)</span>
          <input id="readingDelayMs" type="number" value="2000" min="0" max="8000" step="250" style="width:100%">
        </label>
      </div>
      <div class="text-muted" style="margin-top:8px;font-size:0.9em">
        All generation is local (Ollama). Groq evaluates only.
      </div>
    </details>
  </div>

  <!-- Analytics Dashboard (Tabbed) -->
  <div class="collapsed-section">
    <details open>
      <summary>ğŸ“ˆ Analytics & Improvement</summary>
      <div>
        <div class="flex gap-2 mb-2">
          <button onclick="loadAnalytics()" class="secondary-btn">ğŸ”„ Refresh</button>
          <span class="text-muted">Open tabs to explore details</span>
        </div>

        <!-- Tabs Navigation -->
        <div class="flex gap-2 mb-2">
          <button class="secondary-btn" onclick="selectAnalyticsTab('overview')">Overview</button>
          <button class="secondary-btn" onclick="selectAnalyticsTab('runs')">Runs</button>
          <button class="secondary-btn" onclick="selectAnalyticsTab('operators')">Operators</button>
          <button class="secondary-btn" onclick="selectAnalyticsTab('voices')">Voices</button>
          <button class="secondary-btn" onclick="selectAnalyticsTab('judges')">Judges</button>
          <button class="secondary-btn" onclick="selectAnalyticsTab('golden')">Golden</button>
          <button class="secondary-btn" onclick="selectAnalyticsTab('costs')">Costs</button>
          <button class="secondary-btn" onclick="selectAnalyticsTab('thresholds')">Thresholds</button>
          <button class="secondary-btn" onclick="selectAnalyticsTab('memory')">Memory</button>
        </div>

        <!-- Tab: Overview -->
        <div id="tab-overview" class="tab-pane">
          <div id="analyticsOverview" class="hidden">
            <div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;margin-bottom:20px">
              <div class="result-card" style="text-align:center;padding:16px">
                <h4 style="margin:0;color:var(--accent)">Total Runs</h4>
                <div id="totalRuns" class="result-score" style="font-size:1.8em">-</div>
                <div id="timespanDays" class="text-muted" style="font-size:0.9em">-</div>
              </div>
              <div class="result-card" style="text-align:center;padding:16px">
                <h4 style="margin:0;color:var(--accent)">Improvement</h4>
                <div id="improvementPercent" class="result-score" style="font-size:1.8em">-</div>
                <div class="text-muted" style="font-size:0.9em">Recent vs Early</div>
              </div>
              <div class="result-card" style="text-align:center;padding:16px">
                <h4 style="margin:0;color:var(--accent)">Avg Score</h4>
                <div id="overallAvgScore" class="result-score" style="font-size:1.8em">-</div>
                <div class="text-muted" style="font-size:0.9em">All Time</div>
              </div>
            </div>
          </div>
          <div class="result-card" style="margin-bottom:16px">
            <h4 style="margin:0 0 12px 0;color:var(--primary)">ğŸ¯ Score Progression Over Time</h4>
            <div id="scoreChart" style="height:200px;background:var(--surface);border-radius:8px;padding:16px;position:relative;overflow:hidden">
              <div id="scoreChartContent"></div>
            </div>
          </div>
          <div class="result-card">
            <h4 style="margin:0 0 12px 0;color:var(--primary)">ğŸ“‹ Performance by Task Type</h4>
            <div id="taskChart" style="max-height:200px;overflow:auto"></div>
          </div>
        </div>

        <!-- Tab: Runs -->
        <div id="tab-runs" class="tab-pane hidden">
          <div id="evolutionHistory" style="max-height:300px;overflow:auto"></div>
          <div class="mt-1"><button onclick="loadEvolutionHistory()" class="secondary-btn">Refresh</button></div>
        </div>

        <!-- Tab: Operators -->
        <div id="tab-operators" class="tab-pane hidden">
          <div class="result-card" style="margin-bottom:16px">
            <h4 style="margin:0 0 12px 0;color:var(--primary)">ğŸš€ Operator Performance</h4>
            <div id="operatorsChart" style="max-height:300px;overflow:auto"></div>
            <div class="text-muted" style="margin-top:8px">Coverage (first 5 iterations): <span id="operatorCoverageK">-</span></div>
          </div>
        </div>

        <!-- Tab: Voices -->
        <div id="tab-voices" class="tab-pane hidden">
          <div id="voicesChart" class="text-muted">Voice analytics will appear here when enabled.</div>
        </div>

        <!-- Tab: Judges -->
        <div id="tab-judges" class="tab-pane hidden">
          <div class="result-card">
            <h4 style="margin:0 0 12px 0;color:var(--primary)">ğŸ§‘â€âš–ï¸ Judges</h4>
            <div style="display:flex;gap:16px;flex-wrap:wrap">
              <div>Evaluated: <strong id="judgeEvaluated">-</strong></div>
              <div>Tie-breaker rate: <strong id="tieBreakerRate">-</strong></div>
              <div>Eval latency p50: <strong id="evalP50">-</strong> ms</div>
              <div>Eval latency p90: <strong id="evalP90">-</strong> ms</div>
            </div>
          </div>
        </div>

        <!-- Tab: Golden -->
        <div id="tab-golden" class="tab-pane hidden">
          <div class="flex gap-2 mb-1">
            <button onclick="runGoldenSet()" class="secondary-btn">ğŸ Run Golden Set</button>
          </div>
          <div class="result-card">
            <h4 style="margin:0 0 12px 0;color:var(--primary)">ğŸ Golden Set Summary</h4>
            <div id="goldenSummary" style="max-height:260px;overflow:auto"></div>
            <div id="goldenRunResult" class="text-muted" style="margin-top:8px"></div>
          </div>
        </div>

        <!-- Tab: Costs -->
        <div id="tab-costs" class="tab-pane hidden">
          <div class="result-card">
            <h4 style="margin:0 0 12px 0;color:var(--primary)">ğŸ’° Costs & Latency</h4>
            <div class="text-muted">Evaluation latency p50/p90: <span id="costEvalP50">-</span> / <span id="costEvalP90">-</span> ms</div>
            <div class="text-muted">Golden avg cost penalty: <span id="goldenAvgCost">-</span></div>
          </div>
        </div>

        <!-- Tab: Thresholds -->
        <div id="tab-thresholds" class="tab-pane hidden">
          <div class="result-card">
            <h4 style="margin:0 0 12px 0;color:var(--primary)">âš™ï¸ Thresholds</h4>
            <div class="text-muted">Delta Reward Min: <span id="thDelta">-</span></div>
            <div class="text-muted">Cost Ratio Max: <span id="thCost">-</span></div>
            <div class="text-muted">Golden Pass Target: <span id="thPass">-</span></div>
          </div>
        </div>

        <!-- Tab: Memory -->
        <div id="tab-memory" class="tab-pane hidden">
          <div id="memoryError" class="hidden"></div>
          
          <!-- Memory Overview -->
          <div id="memoryOverview" class="hidden">
            <h4 style="color:var(--primary);margin-bottom:16px">ğŸ§  Memory System Analytics</h4>
            
            <!-- Key Metrics -->
            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-bottom:20px">
              <div class="result-card" style="text-align:center;padding:16px">
                <h5 style="margin:0;color:var(--accent)">Hit Rate</h5>
                <div id="memoryHitRate" class="result-score" style="font-size:1.8em">-</div>
              </div>
              <div class="result-card" style="text-align:center;padding:16px">
                <h5 style="margin:0;color:var(--accent)">Avg Reward Lift</h5>
                <div id="memoryAvgRewardLift" class="result-score" style="font-size:1.8em">-</div>
              </div>
              <div class="result-card" style="text-align:center;padding:16px">
                <h5 style="margin:0;color:var(--accent)">Store Size</h5>
                <div id="memoryStoreSize" class="result-score" style="font-size:1.8em">-</div>
              </div>
            </div>

            <!-- Additional Metrics -->
            <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-bottom:20px">
              <div class="result-card" style="text-align:center;padding:12px">
                <h6 style="margin:0;color:var(--muted)">Primer Tokens P50</h6>
                <div id="memoryPrimerTokensP50" style="font-size:1.2em">-</div>
              </div>
              <div class="result-card" style="text-align:center;padding:12px">
                <h6 style="margin:0;color:var(--muted)">Primer Tokens P95</h6>
                <div id="memoryPrimerTokensP95" style="font-size:1.2em">-</div>
              </div>
              <div class="result-card" style="text-align:center;padding:12px">
                <h6 style="margin:0;color:var(--muted)">Total Runs</h6>
                <div id="memoryTotalRuns" style="font-size:1.2em">-</div>
              </div>
            </div>

            <!-- Task Class Breakdown -->
            <div class="result-card" style="margin-bottom:20px">
              <h5 style="margin:0 0 12px 0;color:var(--primary)">ğŸ“Š Performance by Task Class</h5>
              <div id="memoryTaskClassBreakdown">Loading...</div>
            </div>
          </div>
          
          <!-- Recent Runs -->
          <div id="memoryRecentRuns" class="hidden">
            <div class="result-card">
              <h5 style="margin:0 0 12px 0;color:var(--primary)">ğŸ• Recent Memory Runs</h5>
              <div style="overflow-x:auto">
                <div id="memoryRecentRunsTable">Loading...</div>
              </div>
            </div>
          </div>
        </div>

        <div id="analyticsError" class="hidden" style="color:var(--danger);text-align:center;padding:20px">
          Failed to load analytics data
        </div>
      </div>
    </details>
  </div>

  <!-- Hidden compatibility elements -->
  <div class="hidden">
    <input id="sessionSelect">
    <input id="prompt">
    <div id="chatOut"></div>
    <div id="messagesList"></div>
    <div id="out"></div>
    <input id="metaTaskClass">
    <input id="metaIterations">
    <input id="metaBandit">
    <input id="metaEps">
    <input id="metaMemoryK">
    <input id="metaRagK">
    <select id="metaFramework"></select>
    <select id="mrForceEngine"></select>
    <input id="mrCompareGroq">
    <input id="mrJudge">
    <div id="metaOutput"></div>
    <div id="judgeResults"><div id="judgeContent"></div></div>
    <table id="latestRunTable"><tbody></tbody></table>
    <div id="variantOut"></div>
    <div id="groqModels"></div>
  </div>

  <script src="/static/app.js?v=20250906"></script>
</body>
</html>
